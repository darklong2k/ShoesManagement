 
<div  class="container mt-5">
    <h2 class="mb-3">Them san pham</h2>

    <div class="container">
        <form id="productForm" method="post">
            <!-- Tên sản phẩm -->
            <div class="form-group">
                <label for="productName">Tên sản phẩm</label>
                <input type="text" class="form-control" id="productName" name="Name" placeholder="Nhập tên sản phẩm" required />
            </div>

            <!-- Giá tiền -->
            <div class="form-group mt-3">
                <label for="productPrice">Giá tiền</label>
                <input type="number" class="form-control" id="productPrice" name="Price" placeholder="Nhập giá tiền" required />
            </div>

            <!-- Mô tả -->
            <div class="form-group mt-3">
                <label for="productDescription">Mô tả</label>
                <textarea class="form-control" id="productDescription" name="Description" rows="3" placeholder="Nhập mô tả"></textarea>
            </div>

            <!-- Hình ảnh -->
            <div class="form-group mt-3">
                <label for="productImage">Hình ảnh</label>
                <input type="file" class="form-control" id="productImage" name="ImageFile" accept="image/*" onchange="previewImage(event)" />
            </div>
            <div class="mt-3">
                <img id="preview" src="#" alt="Hình ảnh preview" style="max-width: 100px; display: none;" />
            </div>

            <!-- Combobox Nhà cung cấp -->
            <div class="form-group mt-3">
                <label for="supplier">Nhà cung cấp</label>
                <div class="input-group">
                    <select class="form-control" id="supplier" name="SupplierId">
                        <option value="">Chọn nhà cung cấp</option>
                        <option value="1">Nhà cung cấp 1</option>
                        <option value="2">Nhà cung cấp 2</option>
                    </select>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSupplierModal">
                        Thêm nhà cung cấp
                    </button>
                </div>
            </div>

            <!-- Combobox Thương hiệu -->
            <div class="form-group mt-3">
                <label for="brand">Thương hiệu</label>
                <div class="input-group">
                    <select class="form-control" id="brand" name="brandId">
                        <option value="">Chọn thương hiệu</option>
                        <option value="1">Thương hiệu 1</option>
                        <option value="2">Thương hiệu 2</option>
                    </select>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBrandModal">
                        Thêm thương hiệu
                    </button>
                </div>
            </div>

            <!-- Combobox Danh mục -->
            <div class="form-group mt-3">
                <label for="category">Danh mục</label>
                <div class="input-group">
                    <select class="form-control" id="category" name="categoryId">
                        <option value="">Chọn danh mục</option>
                        <option value="1">Danh mục 1</option>
                        <option value="2">Danh mục 2</option>
                    </select>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                        Thêm danh mục
                    </button>
                </div>
            </div>

            <!-- Nút lưu -->
            <button type="submit" class="btn btn-success mt-4">Lưu sản phẩm</button>
        </form>
    </div>
</div>
<!-- Modal Thêm Nhà Cung Cấp -->
<div class="modal fade" id="addSupplierModal" tabindex="-1" aria-labelledby="addSupplierModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSupplierModalLabel">Thêm Nhà Cung Cấp</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Tên Nhà Cung Cấp -->
                <div class="form-group mb-3">
                    <label for="SupplierName">Tên Nhà Cung Cấp</label>
                    <input type="text" class="form-control" id="SupplierName" placeholder="Nhập tên nhà cung cấp" />
                </div>
                
                <!-- Email Người Liên Hệ -->
                <div class="form-group mb-3">
                    <label for="contactEmail">Email Người Liên Hệ</label>
                    <input type="email" class="form-control" id="contactEmail" placeholder="Nhập email người liên hệ" />
                </div>
                <!-- Số Điện Thoại -->
                <div class="form-group mb-3">
                    <label for="contactPhone">Số Điện Thoại</label>
                    <input type="text" class="form-control" id="contactPhone" placeholder="Nhập số điện thoại" />
                </div>
                <!-- Địa Chỉ -->
                <div class="form-group mb-3">
                    <label for="address">Địa Chỉ</label>
                    <input type="text" class="form-control" id="address" placeholder="Nhập địa chỉ" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="saveSupplier()">Lưu</button>
            </div>
        </div>
    </div>
</div>


<!-- Modal Thêm Thương Hiệu -->
<div class="modal fade" id="addBrandModal" tabindex="-1" aria-labelledby="addBrandModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addBrandModalLabel">Thêm Thương Hiệu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newBrand">Tên Thương Hiệu</label>
                    <input type="text" class="form-control" id="newBrand" placeholder="Nhập tên thương hiệu" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="saveBrand()">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Thêm Danh Mục -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCategoryModalLabel">Thêm Danh Mục</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Tên danh mục -->
                <div class="form-group mb-3">
                    <label for="newCategory">Tên Danh Mục</label>
                    <input type="text" class="form-control" id="newCategory" placeholder="Nhập tên danh mục" />
                </div>

                <!-- Danh mục cha (parent_id) -->
                <div class="form-group mb-3">
                    <label for="parentCategory">Danh Mục Cha</label>
                    <select class="form-select" id="parentCategory">
                        <option value="" selected>Không có danh mục cha</option>
                        <!-- Dữ liệu danh mục cha sẽ được thêm vào đây -->
                        <option value="1">Giày Nam</option>
                        <option value="2">Giày Nữ</option>
                    </select>
                </div>

                <!-- Mô tả danh mục -->
                <div class="form-group">
                    <label for="categoryDescription">Mô Tả</label>
                    <textarea class="form-control" id="categoryDescription" rows="3" placeholder="Nhập mô tả danh mục"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="saveCategory()">Lưu</button>
            </div>
        </div>
    </div>
</div>
@section Scripts {

    <script>
        
        function previewImage(event) {
            const input = event.target;
            const preview = document.getElementById('preview');

            if (input.files && input.files[0]) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    preview.src = e.target.result; // Gán URL ảnh được tạo
                    preview.style.display = 'block'; // Hiển thị hình ảnh preview
                };

                reader.readAsDataURL(input.files[0]); // Đọc file dưới dạng DataURL
            } else {
                preview.src = '#';
                preview.style.display = 'none'; // Ẩn hình ảnh nếu không có file
            }
        }
        
        function saveSupplier() {
            $('#addSupplierModal').on('hidden.bs.modal', function () {
                $('body').removeClass('modal-open'); // Đảm bảo xóa lớp modal-open
                $('.modal-backdrop').remove(); // Xóa lớp backdrop
            });
            // Lấy giá trị từ các trường input
            const supplierData = {
                SupplierName: document.getElementById('SupplierName').value.trim(),
                email: document.getElementById('contactEmail').value.trim(),
                phone: document.getElementById('contactPhone').value.trim(),
                address: document.getElementById('address').value.trim(),
            };

            // Kiểm tra dữ liệu hợp lệ
            if (!supplierData.SupplierName || !supplierData.email || !supplierData.phone || !supplierData.address) {
                alert('Vui lòng điền đầy đủ thông tin nhà cung cấp.');
                return;
            }

            // Gửi yêu cầu AJAX để thêm nhà cung cấp
            $.ajax({
                url: '/api/SupplierAPI/Create', // Đường dẫn API
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(supplierData), // Chuyển đổi đối tượng thành JSON
                success: function (response) {
                    if (response && response.success) {
                        alert('Nhà cung cấp đã được thêm thành công!');
                        $('#addSupplierModal').modal('hide'); // Đóng modal
                       
                        loadSuppliers(); // Gọi lại hàm loadSupplier để cập nhật danh sách
                    } else {
                        alert('Có lỗi xảy ra. Vui lòng thử lại.');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error:', xhr.responseText);
                    alert('Không thể thêm nhà cung cấp. Vui lòng kiểm tra lại.');
                },
            });
        }
        // Tải danh sách Nhà Cung Cấp
        function loadSuppliers() {
            $.ajax({
                url: 'https://localhost:7103/api/SupplierAPI/getall',  // Endpoint API lấy danh sách nhà cung cấp
                method: 'GET',
                success: function (response) {
                    console.log(response);
                    const suppliers = response.data;
                    const supplierSelect = $('#supplier');
                    supplierSelect.empty();
                    supplierSelect.append('<option value="">Chọn nhà cung cấp</option>');
                    suppliers.forEach(function (supplier) {
                        supplierSelect.append(`<option value="${supplier.supplierId}">${supplier.supplierName}</option>`);
                    });
                },
                error: function (err) {
                    console.log("Error loading suppliers:", err);
                }
            });
        }
        function saveBrand() {
            $('#addBrandModal').on('hidden.bs.modal', function () {
                $('body').removeClass('modal-open'); // Đảm bảo xóa lớp modal-open
                $('.modal-backdrop').remove(); // Xóa lớp backdrop
            });
            // Lấy giá trị từ input
            const brandName = document.getElementById('newBrand').value.trim();

            // Kiểm tra dữ liệu nhập
            if (!brandName) {
                alert('Vui lòng nhập tên thương hiệu.');
                return;
            }

            // Dữ liệu gửi đi
            const brandData = {
                BrandName: brandName
            };

            // Gửi AJAX POST
            $.ajax({
                url: '/api/Brand/Create', // API tạo thương hiệu
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(brandData),
                success: function (response) {
                    if (response.success) {
                        alert('Thương hiệu đã được thêm thành công!');
                        $('#addBrandModal').modal('hide'); // Đóng modal

                        // Tải lại danh sách thương hiệu
                        loadBrands();
                    } else {
                        alert('Có lỗi xảy ra. Vui lòng thử lại.');
                    }
                },
                error: function (xhr) {
                    if (xhr.status === 409) { // Conflict
                        alert('Tên thương hiệu đã tồn tại. Vui lòng chọn tên khác.');
                    } else {
                        console.error('Error:', xhr.responseText);
                        alert('Không thể thêm thương hiệu. Vui lòng thử lại.');
                    }
                },
            });
        }
        function saveCategory() {
            $('#addCategoryModal').on('hidden.bs.modal', function () {
                $('body').removeClass('modal-open'); // Đảm bảo xóa lớp modal-open
                $('.modal-backdrop').remove(); // Xóa lớp backdrop
            });
            // Lấy dữ liệu từ các trường trong modal
            const categoryData = {
                Name: document.getElementById('newCategory').value.trim(),
                ParentId: document.getElementById('parentCategory').value || null, // Null nếu không có danh mục cha
                Description: document.getElementById('categoryDescription').value.trim(),
            };

            // Kiểm tra dữ liệu nhập
            if (!categoryData.Name) {
                alert('Vui lòng nhập tên danh mục.');
                return;
            }

            // Gửi AJAX POST để thêm danh mục
            $.ajax({
                url: '/api/CategoryAPI/Create', // Endpoint API tạo danh mục
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(categoryData),
                success: function (response) {
                    console.log(response);
                    if (response.Success) {
                        alert('Danh mục đã được thêm thành công!'); // Thông báo thành công
                        $('#addCategoryModal').modal('hide'); // Đóng modal

                        // Gọi lại hàm loadCategories để cập nhật danh sách danh mục
                        loadCategories();
                    } else {
                        alert(response.Message); // Thông báo lỗi từ server
                    }
                },
                error: function (xhr) {
                    const errorResponse = xhr.responseJSON || {};
                    const errorMessage = errorResponse.Message || 'Không thể thêm danh mục. Vui lòng thử lại.';
                    alert(errorMessage);
                },
            });
        }
        // Tải danh sách Thương Hiệu
        function loadBrands() {
            $.ajax({
                url: 'https://localhost:7103/api/Brand/getall',  // Endpoint API lấy danh sách thương hiệu
                method: 'GET',
                success: function (response) {
                    console.log(response);
                    const brands = response.data;
                    const brandSelect = $('#brand');
                    brandSelect.empty();
                    brandSelect.append('<option value="">Chọn thương hiệu</option>');
                    brands.forEach(function (brand) {
                        brandSelect.append(`<option value="${brand.brandId}">${brand.brandName}</option>`);
                    });
                },
                error: function (err) {
                    console.log("Error loading brands:", err);
                }
            });
        }

        // Tải danh sách Danh Mục
        function loadCategories() {
            $.ajax({
                url: '/api/CategoryAPI/GetAll',  // Endpoint API lấy danh mục
                method: 'GET',
                success: function (response) {
                    console.log(response);
                    const categories = response.categories;
                    const categorySelect = $('#category');
                    categorySelect.empty();
                    categorySelect.append('<option value="">Chọn danh mục</option>');
                    categories.forEach(function (category) {
                        categorySelect.append(`<option value="${category.categoryId}">${category.name}</option>`);
                    });
                },
                error: function (err) {
                    console.log("Error loading categories:", err);
                }
            });
        }

        // Thêm sản phẩm
        function addProduct(formData) {

            $.ajax({
                url: '/api/ProductAPI/Create', // Endpoint API thêm sản phẩm
                method: 'POST',
                data: formData,
                processData: false, // Không xử lý dữ liệu để hỗ trợ FormData
                contentType: false, // Không gán Content-Type vì FormData sẽ tự động làm việc này
                success: function (response) {
                    console.log(response);
                    if (response.success) {

                        alert('Sản phẩm đã được thêm thành công!');
                        // Chuyển hướng về trang Product_Page
                        window.location.href = '/Admin/Home/Product_Page';
                    } else {
                        alert('Không thể thêm sản phẩm. Vui lòng thử lại.');
                    }
                },
                error: function (err) {
                    console.error("Error adding product:", err);
                    const errorResponse = err.responseJSON || {};
                    alert(errorResponse.Message || 'Có lỗi xảy ra trong quá trình thêm sản phẩm.');
                }
            });
        }


        // Khởi tạo dữ liệu ban đầu
        $(document).ready(function () {
            
            loadSuppliers();
            loadBrands();
            loadCategories();

            // Xử lý sự kiện khi form sản phẩm được submit
            $('#productForm').submit(function (event) {
                event.preventDefault();

                var formData = new FormData(this);  // Lấy dữ liệu từ form
                for (var pair of formData.entries()) {
                    console.log(pair[0] + ": " + pair[1]);
                }
                addProduct(formData);
            });
        });

        
    </script>
}