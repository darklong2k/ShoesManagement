@{
    ViewData["Title"] = "Trang cá nhân";
}﻿
<link href="~/css/TrangCaNhan.css" rel="stylesheet" />

<div class="container my-4">
    <div class="row">
        <div class="col-lg-3">
            <div class="bg-light p-4 rounded shadow-sm">
                <h4 class="text-center mb-4">Trang Cá Nhân</h4>
                <div class="nav flex-column">
                    <a href="javascript:void(0);" class="nav-link text-dark active" onclick="showSection('personal-info')" id="nav-personal-info">
                        <i class="fas fa-user-circle"></i> Thông Tin Cá Nhân
                    </a>
                    <a href="javascript:void(0);" class="nav-link text-dark" onclick="showSection('order-list')" id="nav-order-list">
                        <i class="fas fa-box"></i> Quản Lý Đơn Hàng
                    </a>
                    <a href="javascript:void(0);" class="nav-link text-dark" onclick="showSection('favorite-products')" id="nav-favorite-products">
                        <i class="fas fa-heart"></i> Sản Phẩm Yêu Thích
                    </a>
                    <a href="javascript:void(0);" class="nav-link text-dark" onclick="showSection('rated-products')" id="nav-rated-products">
                        <i class="fas fa-star"></i> Sản Phẩm Đã Chấm Điểm
                    </a>
                    <a href="#" class="nav-link text-dark" data-bs-toggle="modal" data-bs-target="#changePasswordModal"><i class="fas fa-lock"></i> Đổi Mật Khẩu</a>
                    <a href="#" id="DangXuat" class="nav-link text-dark"><i class="fas fa-sign-out-alt"></i> Đăng Xuất</a>
                </div>
            </div>
        </div>

        <div class="col-lg-9">
            <div id="personal-info" class="section-content mb-4">
                <div class="d-flex align-items-center mb-4">
                    <h4 class="mb-0" id="ACCNAME"></h4>
                </div>
                <div class="card shadow-sm">
                    <div class="card-body">
                        <input type="hidden" id="customerId"/>
                        <input type ="hidden" id="acc_id"/>
                        <table class="table table-bordered">
                            <tbody>
                                <tr><th>Tên:</th><td id="CUS_NAME"></td></tr>
                                <tr><th>Địa chỉ email:</th><td id="CUS_EMAIL"></td></tr>
                                <tr><th>Số điện thoại:</th><td id="CUS_PHONE"></td></tr>
                                <tr><th>Địa chỉ:</th><td id="CUS_ADDRESS"></td></tr>
                                <tr><th>Giới tính:</th><td id="CUS_SEX"></td></tr>
                            </tbody>
                        </table>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editPersonalInfoModal" id="EditInFo">Chỉnh Sửa Thông Tin Cá Nhân</button>
                    </div>
                </div>
            </div>

            <div id="order-list" class="section-content mb-4" style="display: none;">
                <h4 class="mb-3">Quản Lý Đơn Hàng</h4>
               
                
            </div>
            <div id="order-details" class="section-content mb-4" style="display: none;">
                <h4 class="mb-3">Quản Lý Đơn Hàng</h4>
            </div>

            <div id="favorite-products" class="section-content mb-4" style="display: none;">
                <h4 class="mb-3">Sản Phẩm Yêu Thích</h4>
                
            </div>

            <div id="rated-products" class="section-content mb-4" style="display: none;">
                <h4 class="mb-3">Sản Phẩm Đã Chấm Điểm</h4>
               
            </div>
        </div>
    </div>
</div>


<!-- Modal Chỉnh Sửa Thông Tin Cá Nhân -->
<div class="modal fade" id="editPersonalInfoModal" tabindex="-1" aria-labelledby="editPersonalInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPersonalInfoModalLabel">Chỉnh Sửa Thông Tin Cá Nhân</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editPersonalInfoForm">
                    <div class="mb-3">
                        <label for="editName" class="form-label">Tên</label>
                        <input type="text" class="form-control" id="editName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">Địa chỉ email</label>
                        <input type="email" class="form-control" id="editEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPhone" class="form-label">Số điện thoại</label>
                        <input type="text" class="form-control" id="editPhone" required>
                    </div>
                    <div class="mb-3">
                        <label for="editAddress" class="form-label">Địa chỉ</label>
                        <input type="text" class="form-control" id="editAddress" required>
                    </div>
                    <div class="mb-3">
                        <label for="editSex" class="form-label">Giới tính</label>
                        <select class="form-control" id="editSex" required>
                            <option value="1">Nam</option>
                            <option value="0">Nữ</option>
                        </select>
                    </div>
                    <div class="d-flex justify-content-between">
                        <!-- Nút Hủy -->
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <!-- Nút Cập Nhật -->
                        <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>




<!-- Modal Đổi Mật Khẩu -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changePasswordModalLabel">Đổi Mật Khẩu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm" method="post">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">Mật khẩu hiện tại</label>
                        <input type="password" class="form-control" id="currentPassword" placeholder="Nhập mật khẩu hiện tại" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">Mật khẩu mới</label>
                        <input type="password" class="form-control" id="newPassword" placeholder="Nhập mật khẩu mới" required>
                    </div>
                    <div class="mb-3">
                        <label for="confirmNewPassword" class="form-label">Xác nhận mật khẩu mới</label>
                        <input type="password" class="form-control" id="confirmNewPassword" placeholder="Xác nhận mật khẩu mới" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Cập nhật mật khẩu</button>
                </form>
            </div>
        </div>
    </div>
</div>




@section Scripts {
    <script>
        function showSection(sectionId) {
            document.querySelectorAll('.section-content').forEach(section => section.style.display = 'none');
            document.getElementById(sectionId).style.display = 'block';
            document.querySelectorAll('.nav-link').forEach(item => item.classList.remove('active'));
            document.getElementById('nav-' + sectionId).classList.add('active');
        }
        document.addEventListener("DOMContentLoaded", () => showSection('personal-info'));
    </script>
}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $.ajax({
            url: 'https://localhost:7103/api/homeapi/TrangCaNhan',
            type: 'GET',
            success: function (res) {
                // Điền thông tin lên giao diện
                $('#ACCNAME').text(res.username);

                $('#CUS_NAME').text(res.custumerInFo.name || '');
                $('#CUS_EMAIL').text(res.custumerInFo.email || '');
                $('#CUS_PHONE').text(res.custumerInFo.phone || '');
                $('#CUS_ADDRESS').text(res.custumerInFo.address || '');
                $('#CUS_SEX').text(res.custumerInFo.sex === 1 ? 'Nam' : (res.custumerInFo.sex === 0 ? 'Nữ' : ''));
                $('#customerId').val(res.custumerInFo.customerId);
                $('#acc_id').val(res.custumerInFo.accountId);
                console.log(res);

                // Gán sự kiện khi nhấn nút "Chỉnh Sửa Thông Tin Cá Nhân"
                $('#EditInFo').click(function () {
                    // Điền thông tin vào modal
                    $('#editName').val(res.custumerInFo.name || '');
                    $('#editEmail').val(res.custumerInFo.email || '');
                    $('#editPhone').val(res.custumerInFo.phone || '');
                    $('#editAddress').val(res.custumerInFo.address || '');
                    $('#editSex').val(res.custumerInFo.sex);
                });
            },
            error: function (err) {
                console.error('Lỗi khi gọi API:', err);
                alert('Không thể tải thông tin cá nhân.');
            }
        });

        $('#DangXuat').on('click', function () {
            $.ajax({
                url: 'https://localhost:7103/api/homeapi/DangXuat',
                type: 'GET',
                success: function (res) {
                    if (res.success) {
                        window.location.href = res.url;
                    }
                }
            });
        });
    });
</script>
@*  // Hiện danh sách đơn hàng *@
<script>
    // Hàm ánh xạ trạng thái sang badge
    function getStatusBadge(status) {
        switch (status) {
            case 'Cancelled':
                return `<span class="badge bg-danger"><i class="fas fa-times-circle"></i>Đã hủy</span>`;
            case 'Pending':
                return `<span class="badge bg-warning"><i class="fas fa-hourglass-half"></i> Đang chờ xác nhận</span>`;
            case 'Packing':
                return `<span class="badge bg-info"><i class="fas fa-box"></i> Đang đóng gói</span>`;
            case 'Shipping':
                return `<span class="badge bg-primary"><i class="fas fa-truck"></i> Đang vận chuyển</span>`;
            case 'Delivered':
                return `<span class="badge bg-success"><i class="fas fa-check-circle"></i> Đã giao</span>`;
            default:
                return `<span class="badge bg-secondary">${status}</span>`;
        }
    }

    // Hàm xây dựng danh sách đơn hàng
    function buildOrderRows(orders) {
        return orders.map(order => {
            const statusBadge = getStatusBadge(order.status);
            const orderDate = order.orderDate
                ? new Date(order.orderDate).toLocaleDateString('vi-VN')
                : 'N/A';

            // Nút "Hủy đơn" và "Đánh giá"
            const cancelBtn = (order.status === 'Pending' || order.status === 'Packing')
                ? `<button class="btn btn-danger btn-sm" onclick="cancelOrder('${order.orderId}')">Hủy đơn</button>`
                : '';
             const reviewBtn = (order.status === 'Delivered')
                 ? `<button class="btn btn-primary btn-sm" onclick="openReviewPopup('${order.orderId}')">Đánh giá</button>`
                 : '';

            return `
                    <tr>
                        <td>${order.orderId || 'N/A'}</td>
                        <td>${orderDate}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="viewDetails('${order.orderId}')">Chi tiết</button>
                            ${cancelBtn}
                            ${reviewBtn}
                        </td>
                    </tr>`;
        }).join('');
    }

    // Hàm tải danh sách đơn hàng
    function loadOrderList() {
        $.ajax({
            url: 'https://localhost:7103/api/Customerapi/PersonalPage',
            method: 'GET',
            success: function (res) {
                if (res.success) {
                    const orderRows = buildOrderRows(res.orderInFo || []);
                    const orderTable = `
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Mã đơn hàng</th>
                                                <th>Ngày đặt</th>
                                                <th>Trạng thái</th>
                                                <th>Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${orderRows}
                                        </tbody>
                                    </table>
                                </div>
                            </div>`;
                    $('#order-list').html(orderTable);
                } else {
                    console.error("API trả về dữ liệu không hợp lệ:", res);
                }
            },
            error: function (err) {
                console.error("Lỗi khi gọi API:", err);
            }
        });
    }

    // Hàm gửi yêu cầu hủy đơn
    function cancelOrder(orderId) {
        if (confirm('Bạn có chắc chắn muốn hủy đơn hàng này?')) {
            $.ajax({
                url: `https://localhost:7103/api/customerapi/${orderId}`,
                method: 'POST',
                success: function (res) {
                    if (res.success) {
                        alert('Đơn hàng đã được hủy.');
                        loadOrderList(); // Cập nhật danh sách
                    } else {
                        alert('Không thể hủy đơn hàng. Vui lòng thử lại.');
                    }
                },
                error: function (err) {
                    console.error("Lỗi khi hủy đơn:", err);
                    alert('Đã xảy ra lỗi. Vui lòng thử lại.');
                }
            });
        }
    }
    // Hàm hiển thị chi tiết đơn hàng
    function viewDetails(orderId) {
        $.ajax({
            url: `https://localhost:7103/api/Customerapi/OrderDetails/${orderId}`,
            method: 'GET',
            success: function (res) {
                if (res.success) {
                    const orderDetails = res.orderDetails || [];
                    const detailRows = orderDetails.map(detail => `
                        <tr>
                                    <td>
                                <img src="/images/${detail.productImage}" alt="Hình ảnh sản phẩm" style="width: 50px; height: 50px; object-fit: cover;" />
                                    </td>

                                <td>${detail.productName}</td>
                                <td>${detail.productDescription}</td>
                                <td>${detail.price.toLocaleString('vi-VN')} đ</td>
                                <td>${detail.sizeName || 'N/A'}</td>
                                <td>${detail.colorName || 'N/A'}</td>

                            
                        </tr>
                    `).join('');

                    const detailTable = `
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <button class="btn btn-secondary mb-3" onclick="returnToOrderList()">Trở về</button>
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                        <th>Ảnh</th>
                                            <th>Tên sản phẩm</th>
                                            <th>Mô tả</th>
                                            <th>Giá</th>
                                            <th>Kích thước</th>
                                            <th>Màu sắc</th>
                                            
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${detailRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;

                    // Hiển thị chi tiết đơn hàng
                    $('#order-list').hide(); // Ẩn danh sách đơn hàng
                    $('#order-details').html(detailTable).show(); // Hiển thị chi tiết đơn hàng
                } else {
                    alert('Không thể tải chi tiết đơn hàng. Vui lòng thử lại.');
                }
            },
            error: function (err) {
                console.error("Lỗi khi tải chi tiết đơn hàng:", err);
                alert('Đã xảy ra lỗi. Vui lòng thử lại.');
            }
        });
    }

    // Hàm trở về danh sách đơn hàng
    function returnToOrderList() {
        $('#order-details').hide(); // Ẩn chi tiết đơn hàng
        $('#order-list').show(); // Hiển thị danh sách đơn hàng
    }

    // Gọi loadOrderList() khi trang được tải
    $(document).ready(function () {
        loadOrderList();
    });
</script>

@* Lưu đổi thông tin cá nhân *@
<script>
    $(document).ready(function () {
        $('#editPersonalInfoForm').on('submit', function (e) {
            e.preventDefault();

            var customerId = $('#customerId').val(); // Lấy ID của khách hàng từ trường ẩn
            var updatedInfo = {
                CustomerId: customerId, // ID khách hàng
                Name: $('#editName').val(),
                Email: $('#editEmail').val(),
                Phone: $('#editPhone').val(),
                Address: $('#editAddress').val(),
                Sex: $('#editSex').val()
            };

            // Gửi yêu cầu PUT với ID khách hàng
            $.ajax({
                url: `https://localhost:7103/api/customerapi/updatePersonalInfo/${customerId}`, //truyền customerId vào URL
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(updatedInfo),
                success: function (response) {
                    if (response.success) {
                        alert(response.message);
                        $('#editPersonalInfoModal').modal('hide'); // Đóng modal
                        location.reload();
                    } else {
                        alert(response.message);
                    }
                },
                error: function (error) {
                    alert("Có lỗi xảy ra. Vui lòng thử lại.");
                }
            });
        });
    });
</script>
<script>
    $(document).ready(function () {
        // Gửi yêu cầu AJAX để lấy danh sách sản phẩm
        $.ajax({
            url: 'https://localhost:7103/api/customerapi/PersonalPage',  // URL API trả về danh sách sản phẩm
            method: 'GET',
            success: function (res) {
                if (res.success) {
                    var wishlist = res.likedProducts || [];
                    var productsHtml = '';  // Khởi tạo chuỗi HTML rỗng

                    // Duyệt qua danh sách sản phẩm trả về
                    wishlist.forEach(product => {
                        productsHtml += `
                                    <div class="col-md-4 mb-3">
                                        <div class="card shadow-sm">
                                                    <img src="/images/${product.productImage}" class="card-img-top" alt="Product Image">
                                            <div class="card-body">
                                                        <h5 class="card-title">${product.productName}</h5>
                                                            <p class="card-text">Giá: ${product.prodcutPrice.toLocaleString()} VND</p>
                                                                 <button class="btn btn-danger btn-sm" data-id="${product.prodcuctId}" onclick="removeFromWishlist(${product.prodcuctId})">Bỏ yêu thích</button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                    });
                    var table = `<div class="row">
                            ${productsHtml}
                            </div>`

                    // Chèn HTML vào phần tử có id là 'favorite-products'
                    $('#favorite-products').html(table);
                }
            },
            error: function (error) {
                alert('Đã xảy ra lỗi khi tải sản phẩm.');

            }
        });
    });

    // Hàm xử lý xóa sản phẩm khỏi danh sách yêu thích
    function removeFromWishlist(productId) {
        // ID của khách hàng, có thể lấy từ thông tin đăng nhập hoặc session
        var customerId = $('#customerId').val();
        // Gửi yêu cầu DELETE để xóa sản phẩm khỏi danh sách yêu thích
        if (confirm('Bạn có chắc chắn muốn bỏ yêu thích sản phẩm này?')) {
            $.ajax({

                url: `https://localhost:7103/api/Customerapi/RemoveFromWishlist/${productId}/${customerId}`,  // Địa chỉ API của bạn
                method: 'DELETE',
                success: function (res) {
                    if (res.success) {
                        location.reload();
                        // Nếu xóa thành công, xóa sản phẩm khỏi giao diện
                        $(`#product-${productId}`).remove();  // Xóa phần tử sản phẩm khỏi trang
                        alert('Sản phẩm đã được bỏ yêu thích.');
                    } else {
                        alert('Đã xảy ra lỗi khi bỏ yêu thích.');
                    }
                },
                error: function (err) {
                    alert('Đã xảy ra lỗi khi gửi yêu cầu.');
                }
            });
        }
    }


</script>
<script>
    $(document).ready(function () {
        // Gọi API để lấy sản phẩm đã chấm điểm
        $.ajax({
            url: 'https://localhost:7103/api/customerapi/PersonalPage', // Thay URL bằng endpoint phù hợp
            type: 'GET',
            success: function (res) {
                if (res.success) {
                    var ratedProducts = res.ratedProducts || [];  // Lấy danh sách sản phẩm đã chấm điểm
                    var productsHtml = '';  // Khởi tạo chuỗi HTML rỗng
                    

                    // Bắt đầu thẻ row trước vòng lặp
                    productsHtml += '<div class="row">';

                    // Lặp qua danh sách sản phẩm và thêm vào DOM
                    ratedProducts.forEach(product => {
                        var rating = '★'.repeat(Math.floor(product.rating)) + '☆'.repeat(5 - Math.floor(product.rating));
                        productsHtml += `
                                <div class="col-md-4 mb-3">
                                    <div class="card shadow-sm">
                                            <img src="/images/${product.productImage}"
                                             class="card-img-top" alt="Product Image">
                                        <div class="card-body">
                                            <h5 class="card-title">${product.productName}</h5>
                                            <p class="card-text">Giá: ${product.productPrice.toLocaleString()} VND</p>
                                            <p class="card-text">Đánh giá: ${rating}</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                    });

                    // Đóng thẻ row sau khi tất cả sản phẩm đã được thêm vào
                    productsHtml += '</div>';

                    // Hiển thị phần sản phẩm đã chấm điểm
                    $('#rated-products').html(productsHtml);
                } else {
                    alert('Không có sản phẩm đã chấm điểm.');
                }
            },
            error: function (err) {
                console.error(err);
                alert('Có lỗi xảy ra khi lấy danh sách sản phẩm.');
            }
        });
    });
</script>
<script>
    $(document).ready(function () {
        // Lắng nghe sự kiện submit form
        $('#changePasswordForm').on('submit', function (event) {
            event.preventDefault(); // Ngừng hành động mặc định của form

            var acc_id = $('#acc_id').val(); // Lấy giá trị từ input acc_id
            var CurrentPassword = $('#currentPassword').val(); // Lấy mật khẩu hiện tại
            var newPassword = $('#newPassword').val(); // Lấy mật khẩu mới
            var confirmNewPassword = $('#confirmNewPassword').val(); // Lấy mật khẩu xác nhận

            // Kiểm tra xem mật khẩu mới và xác nhận mật khẩu có khớp không
            if (newPassword !== confirmNewPassword) {
                alert("Mật khẩu mới và mật khẩu xác nhận không khớp.");
                return;
            }

            // Tạo đối tượng updatePassWord với các giá trị
            var updatePassWord = {
                AccountId: acc_id,

                Password: newPassword // Chỉnh sửa: gửi mật khẩu mới thay vì mật khẩu xác nhận // matkhau moi
            };
            console.log(updatePassWord);
            // Gửi yêu cầu AJAX tới API
            $.ajax({
                url: `https://localhost:7103/api/homeapi/ChangePassWord/${acc_id}`,  // URL tới API, sử dụng template string đúng
                type: 'POST', // Đổi mật khẩu sử dụng PUT
                data: { acc_id: acc_id, newPassword: newPassword, CurrentPassword: CurrentPassword }, // Gửi đối tượng updatePassWord vào body
                success: function (response) {
                    if (response.success) {
                        alert("Mật khẩu đã được thay đổi thành công.");
                        $('#changePasswordModal').modal('hide');  // Đóng modal nếu thành công
                    } else {
                        alert(response.message);  // Hiển thị thông báo lỗi
                    }
                },
                error: function (xhr, status, error) {
                    alert("Có lỗi xảy ra. Vui lòng thử lại.");
                }
            });
        });
    });
</script>
