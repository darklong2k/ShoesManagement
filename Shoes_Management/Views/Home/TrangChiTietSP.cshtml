@{
    ViewData["Title"] = "Chi tiết sản phẩm";
}
<link href="~/css/TrangChiTietSP.css" rel="stylesheet" />

<div class="container mt-5">
    <!-- Product Details Section -->
    <div class="row">
        <!-- Product Images -->
        <div class="col-md-6">
            <div class="text-center mb-3">
                <img style="border: 1px solid black;border-radius:5px" id="mainImage" src="~/images/T1.svg" class="img-fluid rounded" alt="Main Shoe Image">
            </div>
        </div>

        <!-- Product Info -->
        <div class="col-md-6 product-info">
            <h3 class="fw-bold" >Đang tải...</h3> <!-- Để mặc định là "Đang tải..." -->
            <div class="d-flex align-items-center">
                <span class="text-warning me-2">★★★★☆</span>
                <span>(4.5)</span>
                <span class="ms-4"><strong>Lượt thích:</strong> 120</span>
                <span class="ms-4"><strong>Lượt xem:</strong> 300</span>
            </div>
            <p class="mt-2"><strong>Tổng kho:</strong> <span id="totalStock">Đang tải...</span></p>
            <h4 class="text-danger fw-bold mt-3">Đang tải...</h4> <!-- Hiển thị giá sản phẩm sau khi API trả về -->
            <!-- Color and Size -->
            <div>
                <label for="colorSelect" class="form-label">Màu sắc</label>
                <select class="form-select" id="colorSelect">
                    <!-- Các option sẽ được nạp từ API -->
                </select>
            </div>
            <div>
                <label for="sizeSelect" class="form-label">Kích thước</label>
                <select class="form-select" id="sizeSelect">
                    <!-- Các option sẽ được nạp từ API -->
                </select>
            </div>

            <!-- Quantity -->
            <div>
                <label for="quantityInput" class="form-label">Số lượng</label>
                <input type="number" id="quantityInput" class="form-control w-25" value="1" min="1">
                <p class="mb-0"><strong>Còn lại:</strong> <span id="stockCount">Đang tải...</span> sản phẩm</p>
            </div>

            <!-- Buttons -->
            <div class="d-flex align-items-center mt-4">
                <button class="btn btn-primary me-2">Thêm vào giỏ hàng</button>
                <button class="btn btn-outline-danger btn-wishlist">
                    <i class="bi bi-heart"></i> Thêm vào danh sách yêu thích
                </button>
            </div>
        </div>
    </div>

    <!-- Description Section -->
    <div class="row mt-5">
        <h4>Mô tả</h4>
        <div class="col-md-12">
            <p id="productDescription">Đang tải...</p> <!-- Hiển thị mô tả sản phẩm sau khi API trả về -->
        </div>
    </div>

    <!-- Reviews Section -->
    <div class="row mt-5">
        <h4>Đánh giá của khách hàng</h4>
        <div class="col-md-12">
            <!-- Hiển thị điểm trung bình và số lượng đánh giá -->
            <p><strong>Đánh giá trung bình:</strong> 4.5/5.0</p>
            <p><strong>Tổng số đánh giá:</strong> 2 đánh giá</p>

            <!-- Danh sách các đánh giá -->
            <div class="review">
                <p><strong>John Doe</strong> - <span class="text-warning">★★★★★</span> 4.5/5.0</p>
                <p>Rất thoải mái và phong cách. Rất đáng mua!</p>
            </div>
            <hr>
            <div class="review">
                <p><strong>Jane Smith</strong> - <span class="text-warning">★★★★☆</span> 4.0/5.0</p>
                <p>Giá cả hợp lý, nhưng độ bền của đế giày có thể cải thiện.</p>
            </div>
        </div>
    </div>

    <!-- Sản phẩm liên quan -->
    <section class="pt-4 pb-4">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold mb-0">Sản phẩm liên quan</h3>
                <a href="/tat-ca-san-pham" class="btn btn-outline-primary btn-sm">Xem tất cả</a>
            </div>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4">
                <!-- Sản phẩm liên quan: Giữ nguyên phần này -->
                <div class="col">
                    <div class="card h-100">
                        <a href="https://kingshoes.vn/air-force-1-cw2288-111.html">
                            <img src="https://kingshoes.vn/data/upload/thumb/sneaker-315122-111-air-force-1-07-nike-kingshoesvn-tphcm-tanbinh-17-logo-1551924204-jpg/500_SNEAKER-315122-111-AIR-FORCE-1-07-NIKE-KINGSHOES.VN-TPHCM-TANBINH-17-logo-1551924204-.jpg.webp"
                                 class="card-img-top" alt="AIR FORCE 1">
                        </a>
                        <div class="card-body">
                            <a href="https://kingshoes.vn/air-force-1-cw2288-111.html" style="text-decoration:none">
                                <h5 class="card-title">AIR FORCE 1</h5>
                            </a>
                            <div>
                                <span class="text-warning">★★★★☆</span>
                            </div>
                            <p class="text-danger">3,200,000 đ</p>
                        </div>
                    </div>
                </div>
                <!-- Các sản phẩm khác giữ nguyên -->
                <div class="col">
                    <div class="card h-100">
                        <a href="https://kingshoes.vn/air-force-1-cw2288-111.html">
                            <img src="https://kingshoes.vn/data/upload/thumb/sneaker-315122-111-air-force-1-07-nike-kingshoesvn-tphcm-tanbinh-17-logo-1551924204-jpg/500_SNEAKER-315122-111-AIR-FORCE-1-07-NIKE-KINGSHOES.VN-TPHCM-TANBINH-17-logo-1551924204-.jpg.webp"
                                 class="card-img-top" alt="AIR FORCE 1">
                        </a>
                        <div class="card-body">
                            <a href="https://kingshoes.vn/air-force-1-cw2288-111.html" style="text-decoration:none">
                                <h5 class="card-title">AIR FORCE 1</h5>
                            </a>
                            <div>
                                <span class="text-warning">★★★★☆</span>
                            </div>
                            <p class="text-danger">3,200,000 đ</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>

    $(document).ready(function () {
        const productId = 1; // Thay bằng ID động nếu cần
        const apiUrl = `/api/user/ProductDetailsAPI/GetProductDetails/${productId}`;


        // Gọi API bằng Ajax
        $.ajax({
            url: apiUrl,
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                console.log("Dữ liệu nhận được từ API: ", data);
                if (data.success) {

                    const product = data.product;
                    var html = ""

                    // Hiển thị thông tin sản phẩm
                    $('.product-info h3').text(product.name);
                    $('.product-info .text-danger').text(new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(product.price));
                    $('#totalStock').text(`${product.productDetails.reduce((sum, p) => sum + p.stockQuantity, 0)} sản phẩm`);
                    $('#productDescription').text(product.description);

                   

                    // Đổ dữ liệu vào select màu sắc
                    const colorSelect = $('#colorSelect');
                    const colors = [...new Set(product.productDetails.map(pd => pd.color))];
                    colorSelect.empty(); // Xóa các option cũ
                    colors.forEach(color => {
                        colorSelect.append(new Option(color, color));
                    });

                    // Đổ dữ liệu vào select kích thước
                    const sizeSelect = $('#sizeSelect');
                    const sizes = [...new Set(product.poductDetails.map(pd => pd.size))];
                    sizeSelect.empty(); // Xóa các option cũ
                    sizes.forEach(size => {
                        sizeSelect.append(new Option(size, size));
                    });

                    // Cập nhật tồn kho theo màu sắc và kích thước
                    window.stockData = product.productDetails.reduce((acc, pd) => {
                        acc[pd.Color] = acc[pd.Color] || {};
                        acc[pd.Color][pd.Size] = pd.stockQuantity;
                        return acc;
                    }, {});

                    updateStock(); // Cập nhật hiển thị số lượng tồn kho ban đầu
                } else {
                    $('.product-info').html('<div class="alert alert-danger">Sản phẩm không tồn tại hoặc đã bị ẩn.</div>');
                }
            },
            error: function (xhr, status, error) {
                console.error("Lỗi khi gọi API:", xhr.responseText);
                alert('Lỗi khi tải dữ liệu từ máy chủ.');
            }
        });

        // Hàm cập nhật tồn kho dựa trên lựa chọn
        function updateStock() {
            const color = $('#colorSelect').val();
            const size = $('#sizeSelect').val();

            const stock = window.stockData[color] && window.stockData[color][size] ? window.stockData[color][size] : 0;

            $('#stockCount').text(stock);
        }

        // Gắn sự kiện onchange cho các select
        $('#colorSelect, #sizeSelect').on('change', updateStock);
    });
</script>

